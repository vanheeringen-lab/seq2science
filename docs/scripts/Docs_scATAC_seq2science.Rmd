---
title: "Seq2science SnapATAC"
output: html_document
---

Install the SnapATAC library from the SnapATAC github
Change the location of the seq2science_output_dir to the output dir of the seq2Science workflow.
Also generate a output figure directory to export the figures genereated by R to.
```{r setup}
#library(devtools)
#install_github("r3fang/SnapATAC")
library('SnapATAC')

seq2science_output_dir <- "/home/jsmits/seq2science_scATAC_example"
output_figure_dir <- paste(seq2science_output_dir, '/output_figures', sep ="")
dir.create(output_figure_dir, showWarnings = FALSE)
```

Load all the snap objects generated by the seq2Science workflow into one large snap object
```{r create_snap_object}
snap_dir <- paste(seq2science_output_dir, '/snap', sep = "")

file.list = list.files(path = snap_dir, pattern = c("binned.snap"), all.files = FALSE,full.names = TRUE, include.dirs = TRUE, no.. = FALSE)
sample.list =list.files(path = snap_dir, pattern = c("binned.snap"), all.files = FALSE,full.names = FALSE, include.dirs = FALSE, no.. = FALSE)
sample.list = gsub(".binned.snap","",sample.list)

x.sp = createSnap(file=file.list, sample=sample.list)
```
The barcodes of the snapobject correlate to the single cell fastq file name
```{r check_barcodes}
x.sp@barcode[c(1:10)]
```

If you processed mulitple cell types and want to add this as metadata to the snapobject you need to generate a
aditional samples.tsv file (samples_metadata.tsv) containing the sample filenames and the additional metadata. If you dont want to add aditional metadata you can skiphe next step.
Here is an example of how such a metadata file should look like:
```{r sample_metadata_file_example}
samples_metadata_subset <- read.csv2(paste(seq2science_output_dir, '/samples_metadata_subset.tsv', sep = ""), sep = '\t')
samples_metadata_subset
```
(Optional) Merge the metadata from your metadata file to the snap object.
```{r merge_metadata}
samples_metadata <- read.csv2(paste(seq2science_output_dir, '/samples_metadata.tsv', sep = ""), sep = '\t')
samples_metadata$sample_name <- lapply(samples_metadata$sample_name, toupper)

samples_metadata <- samples_metadata[samples_metadata$sample_name %in% x.sp@barcode,]
samples_metadata <- as.data.frame(samples_metadata[order(match(samples_metadata$sample_name,x.sp@barcode)),])
x.sp@metaData$cell_type <- samples_metadata$cell_type
```

Now you succesfully have generated a snap object, and you can generate single cell QC statistics
```{r SnapATAC QC}
pdf(paste(output_figure_dir,'/barcodeQC.pdf',sep=""),width=6,height=6,paper='special') 
for (name in unique(x.sp@sample)){
  plotBarcode(
	obj=x.sp[x.sp@sample==name,], 
	pdf.file.name=NULL, 
	pdf.width=7, 
	pdf.height=7, 
	col="grey",
	border="grey",
	breaks=50)
  mtext(name, outer=TRUE,  cex=1, line=-1)
}
dev.off()

plotBarcode(
	obj=x.sp[x.sp@sample==x.sp@sample[1],], 
	pdf.file.name=NULL, 
	pdf.width=7, 
	pdf.height=7, 
	col="grey",
	border="grey",
	breaks=50)
  mtext(name, outer=TRUE,  cex=1, line=-1)
```

add cell-by-bin matrix (Generated by SNAPtools in the celseq pipeline)
```{r add_bmat}
#bmat is added:
x.sp = addBmatToSnap(x.sp, bin.size=5000, num.cores=1)
x.sp = makeBinary(x.sp, mat="bmat")
```

From this point you can continue with a workflow tutorial from SnapATAC:https://github.com/r3fang/SnapATAC


