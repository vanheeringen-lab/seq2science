# complement the configuration
configfile: "config.yaml"


# do onstart/onexit things
sample_schemas = ['sample', 'assembly', 'strandedness', 'merge_replicates']
config_schemas = ['general', 'download', 'alignment_general', 'alignment_specific', 'gene_expression', 'assembly_hub']
include: "../../rules/configuration.smk"


# load the remaining relevant rules
include: f"{config['rule_dir']}/alignment.smk"
include: f"{config['rule_dir']}/assembly_hub.smk"
include: f"{config['rule_dir']}/DE_analysis.smk"
include: f"{config['rule_dir']}/gene_counts.smk"
include: f"{config['rule_dir']}/get_genome.smk"
include: f"{config['rule_dir']}/get_fastq.smk"
include: f"{config['rule_dir']}/merge_replicates.smk"
include: f"{config['rule_dir']}/qc.smk"
include: f"{config['rule_dir']}/trimming.smk"


# load the quality control files
quality_control = [get_trimming_qc, get_alignment_qc]

# load DE analysis contrasts
contrasts = get_contrasts()

# list all bigwigs generated by this workflow
bigwigs = get_rna_bigwigs

rule count_all:
    """
    count expressed genes per assembly and (optionally) perform differential expression analysis
    """
    input:
        bigwigs, # [expand(f"{{result_dir}}/bigwigs/{samples.loc[sample]['assembly']}-{sample}.{config['bam_sorter']}-{config['bam_sort_order']}{bw}.bw", **config) for sample in samples.index for bw in get_bigwig_strand(sample) if config.get('bam_bigwig', False)],
        expand("{result_dir}/gene_counts/{assemblies}-counts.tsv",              **{**config, **{'assemblies': set(samples['assembly'])}}),

        expand("{qc_dir}/multiqc_{assemblies}.html",                            **{**config, **{'assemblies': set(samples['assembly'])}}),

        [expand(f"{{result_dir}}/{{diffexp}}/{{assemblies}}-{contrast}.{data}", **{**config, **{'assemblies': set(samples['assembly'])}}) for data in ['diffexp.tsv', 'ma_plot.svg', 'pca_plot.svg'] for contrast in contrasts if config.get('contrasts', False)], #[expand(f"{{result_dir}}/{{diffexp}}/{{assemblies}}-{contrast}.diffexp.tsv",  **{**config, **{'assemblies': set(samples['assembly'])}}) for contrast in contrasts if config.get('contrasts', False)],
        expand("{result_dir}/deseq2/{assemblies}-clustering.svg",               **{**config, **{'assemblies': set(samples['assembly'])}}),

        expand("{result_dir}/assembly_hub", **config)
